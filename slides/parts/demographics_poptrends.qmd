
```{r}
#| output: false
#| eval: true

source(here::here("slides", "setup.R"))

# get data ----
# acs_data <- readRDS(fs::path(ddir, "acs_data.rds"))
pop <- readRDS(fs::path(ddir, "population", "county_population.rds"))
placepop <- readRDS(fs::path(popdir, "popests_raw.rds"))

```


## Demographics: Population trends

### County fortunes have differed widely over last half-century

```{r}
#| label: population-levels

counties <- c("36083", "36091", "36113", "36115")

capt <-  "\nSource: U.S. Census Bureau and NYS Department of Labor"

pop |> 
  filter(geoid %in% counties) |>
  mutate(ipop=pop / pop[year==2015],
         cpcpop = ipop * 100 - 100,
         .by=geoid) |>
  ggplot(aes(x=year, y=pop / 1000)) +
  geom_line(colour = "blue", linewidth = 1) +
  scale_x_continuous(name = NULL, breaks = seq(1900, 2025, 5)) +
  scale_y_continuous(name = "Thousands of people") +
  ggtitle(label="Population in area counties") +
  labs(caption = capt) +
  theme_minimal() +
  legend_notitle +
  caption_left +
  facet_wrap(~trimname, scales="free_y")

```


### Population declines in Washington County have been persistent and severe

```{r}
#| label: population-changes

counties <- c("36083", "36091", "36113", "36115")

capt1 <-  "Source: U.S. Census Bureau and NYS Department of Labor"
capt2 <- "Note: Bump in 2020 reflects 2020 decennal census break from prior estimates"
capt <- paste0("\n", capt1, "\n", capt2)

baseyear <- 2010
pop |> 
  filter(geoid %in% counties) |>
  mutate(ipop=pop / pop[year==baseyear],
         cpcpop = ipop * 100 - 100,
         .by=geoid) |>
  filter(year >= baseyear) |>
  ggplot(aes(x=year, y=cpcpop, colour=trimname)) +
  geom_line(linewidth = 1) +
  geom_hline(yintercept = 0, linetype="solid", linewidth = .5) +
  scale_x_continuous(name = NULL, breaks = seq(baseyear, 2025, 1)) +
  scale_y_continuous(name = "Cumulative percentage change",
                     breaks =  seq(-20, 20, 1),
                     labels=scales::comma_format()) +
  ggtitle(label=paste0("Cumulative percentage change in population since ", baseyear)) +
  labs(caption = capt) +
  theme_minimal() +
  legend_notitle +
  caption_left

```


### Population declines in most area villages have been sharp

```{r}
#| output: false
#| eval: true

# add Salem CDP 
baseyear <- 2010

suppressWarnings( # Salem has fewer observations than others, generating warning
  pdata <- placepop |> 
  rename(trimname=name, pop=value) |> 
  filter(state=="36", sumlev=="157") |>  
  mutate(geoid = paste0(state, place)) |> 
  filter(geoid %in% constants$keep_places) |>
  mutate(trimname=ifelse(place=="64771", paste0(trimname, "/CDP"), trimname)) |> 
  add_row(geoid="3664771", state="36", stname="New York", county="115",
          place="64771", trimname="Salem village/CDP", year=2020, src="2020 census", pop=811) |>
  mutate(ipop=pop / pop[year==baseyear],
         cpcpop = ipop * 100 - 100,
         .by=geoid) |>
  arrange(geoid, year)
)
  

```

```{r}
#| label: village-population
#| output: true

capt1 <-  "Source: U.S. Census Bureau. Annual population estimates may not be reliable for small areas such as villages."
capt2 <- "Note: Annual estimates for Salem not easily available after 2010 due to dissolution; 2020 value is decennial census."
capt <- paste0("\n", capt1, "\n", capt2)

pdata |> 
  ggplot(aes(x=year, y=pop)) +
  geom_line(data = pdata  |>  
              filter(!(geoid=="3664771" & year > 2010)),
            colour="blue",
            linewidth = 1,
            linetype="solid") +
  geom_line(data = pdata |> 
              filter(geoid=="3664771", year >= 2010), 
            colour="blue",
            linewidth = 1,
            linetype = "dashed") + # dashed line for Salem
  scale_x_continuous(name = NULL, breaks = seq(1900, 2025, 5)) +
  scale_y_continuous(name = "Number of people") +
  ggtitle(label="Population in area villages") +
  labs(caption = capt) +
  theme_minimal() +
  legend_notitle +
  caption_left +
  facet_wrap(~trimname, scales="free_y", ncol=3)

```


:::{.notes}
Unfortunately the Census Bureau has removed annual population data after 2010 from their website as a result of the village dissolution, which occurred in 2016.
:::

### Cambridge village's population loss has not been as severe as most other area villages

```{r}
#| label: village-population-changes

capt1 <-  "Source: U.S. Census Bureau. Annual population estimates may not be reliable for small areas such as villages."
capt2 <- "Note: Annual estimates for Salem not easily available after 2010 due to dissolution; 2020 value is decennial census."
capt <- paste0("\n", capt1, "\n", capt2)

pdata2 <- pdata |> 
  filter(year >= baseyear)

pdata2 |>
  ggplot(aes(x=year, y=cpcpop, colour=trimname)) +
  geom_line(data = pdata2  |>  
              filter(!(geoid=="3664771")),
            linewidth = 1,
            linetype="solid") +
  geom_line(data = pdata2 |> 
              filter(geoid=="3664771"), 
            linewidth = 1,
            linetype = "dashed") + # dashed line for Salem  
  geom_hline(yintercept = 0, linetype="solid", linewidth = .5) +
  scale_x_continuous(name = NULL, breaks = seq(baseyear, 2025, 1)) +
  scale_y_continuous(name = "Cumulative percentage change",
                     breaks =  seq(-20, 20, 1),
                     labels=scales::comma_format()) +
  ggtitle(label=paste0("Cumulative percentage change in population since ", baseyear)) +
  labs(caption = capt) +
  theme_minimal() +
  legend_notitle +
  caption_left

```


### Child poverty

```{r}
#| output: false
#| eval: false

# https://www2.census.gov/programs-surveys/saipe/datasets/1999/1999-school-districts/ussd99.dat
# https://www2.census.gov/programs-surveys/saipe/datasets/2000/2000-school-districts/ussd00.dat
# https://www2.census.gov/programs-surveys/saipe/datasets/2001/2001-school-districts/ussd01.dat
# https://www2.census.gov/programs-surveys/saipe/datasets/2002/2002-school-districts/ussd02.dat
# https://www2.census.gov/programs-surveys/saipe/datasets/2003/2003-school-districts/ussd03.txt
# https://www2.census.gov/programs-surveys/saipe/datasets/2004/2004-school-districts/ussd04.txt
# https://www2.census.gov/programs-surveys/saipe/datasets/2005/2005-school-districts/ussd05.txt
# https://www2.census.gov/programs-surveys/saipe/datasets/2023/2023-school-districts/ussd23.txt
 
# download saipe school district data ----
urlbase <- "https://www2.census.gov/programs-surveys/saipe/datasets/"
f <- function(year){
  ext <- ifelse(year < 2003, ".dat", ".txt")
  y2 <- str_sub(year, 3, 4)
  url <- paste0(urlbase, year, "/", year, "-school-districts/ussd", y2, ext)
  fname <- fs::path_file(url)
  print(fname)
  download.file(url, fs::path(ddir, "saipe", fname), mode="wb")
}
purrr::walk(1999:2023, f) 

# read sd data with all trailing info as a single var to be parsed ----
sdir <- fs::path(ddir, "saipe")
files <- fs::dir_ls(sdir) |> str_subset("ussd.*\\.(dat|txt)$") |> sort()

starts <- c(1, 4, 10)
ends <- c(2, 8, 130)
cnames <- c("stfips", "distid", "restofrec")
df <- vroom_fwf(files,
                id = "id",
                col_positions = fwf_positions(start=starts, end=ends,
                col_names=cnames))
count(df, id)

df2 <- df |> 
  mutate(y2=str_sub(id, -6, -5),
         year = case_when(y2 > 25 ~ paste0("19", y2),
                          .default = paste0("20", y2)),
         year = as.integer(year)) |> 
  select(-y2, -id) |> 
  relocate(year) |> 
  arrange(stfips, distid, year)

df3 <- df2 |> 
  mutate(rr2 = str_remove(restofrec, "(?i)ussd.*$") |> str_trim()) |> 
  separate(rr2, into = c("sdname", "numeric_fields"), sep = "\\s+", fill = "right", remove=FALSE)


# View the result
# good i think
set.seed(1234)
df_result <- df3  |> 
  # filter(year==2020, stfips=="55", distid=="15090") |>  
  # slice_sample(n=100000) |> 
  mutate(
    # Extract the trailing numeric block (last occurrence of digits)
    numbers_part = str_extract(rr2, "\\d[\\d\\s]*$"),
    # Remove the numeric block from the original text to isolate the name
    name = str_remove(rr2, "\\s*\\d[\\d\\s]*$") %>% str_trim()
  ) %>%
  separate(
    numbers_part,
    into = sprintf("num%d", 1:5),
    sep = "\\s+",
    fill = "right",
    convert = TRUE,
    remove = FALSE
  )

summary(df_result)
saveRDS(df_result, fs::path(ddir, "sd_saipe.rds"))



# argyle 03210
# cambridge 06210
# greenwich 12900
# salem 25470
# schuylerville 26160
# hoosick falls 14760
 
keep_sds <- c("03210", "06210", "12900", "25470", "26160", "14760")

pdata <- df |> 
  filter(stfips == "36", distid %in% keep_sds) |> 
  mutate(trimname=case_when(distid=="06210" ~ "Cambridge",
                            distid=="03210" ~ "Argyle",
                            distid=="12900" ~ "Greenwich",
                            distid=="25470" ~ "Salem",
                            distid=="26160" ~ "Schuylerville",
                            distid=="14760" ~ "Hoosick Falls")) |> 
  arrange(distid)


```

